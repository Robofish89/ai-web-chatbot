<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Val de Vie Assistant (Demo)</title>

  <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
  <style>
    /* Only positions the container; theming is injected into Shadow DOM */
    #n8n-chat{ position:fixed; right:16px; bottom:16px; z-index:2147483600; }
    body{ margin:0; font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; }
  </style>
</head>
<body>
  <div id="n8n-chat"></div>

  <script>
    // --- client config
    const CFG = {
      webhookUrl: "https://n8n.recoverykings.co/webhook/edb8bf04-91b6-420c-b119-a9d24cd8d4d3/chat",
      welcome: "Welcome to Val de Vie Properties! How can I help you today?",
      placeholder: "Type your messageâ€¦",
      headerTitle: "Val de Vie Properties",
    };

    // load the UMD bundle
    function load(url){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=url;s.async=true;s.onload=res;s.onerror=()=>rej(new Error('load fail '+url));document.body.appendChild(s);});}

    // try to call whichever factory the bundle exposes
    function initWidget(){
      const f =
        (window.N8NChat && window.N8NChat.createChat) ||
        window.createChat ||
        (window.Chat && (window.Chat.createChat || window.Chat.create));
      if (typeof f !== 'function') return false;

      // avoid double-mount
      if (!document.querySelector('#n8n-chat n8n-chat')) {
        f({
          webhookUrl: CFG.webhookUrl,
          target: '#n8n-chat',
          position: 'bottom-right',
          placeholder: CFG.placeholder,
          initialMessages: [{ role:'assistant', text: CFG.welcome }],
          header: { title: CFG.headerTitle },
          openOnLoad: true,
        });
      }
      return true;
    }

    // inject brand CSS into the widget Shadow DOM
    function brandShadow(){
      const el = document.querySelector('#n8n-chat n8n-chat') || document.querySelector('body > n8n-chat');
      if (!el || !el.shadowRoot) return false;
      if (!el.shadowRoot.getElementById('vdv-shadow-theme')){
        const st = document.createElement('style');
        st.id = 'vdv-shadow-theme';
        st.textContent = `
          .header{background:#000!important;color:#fff!important}
          .header-title{font-size:0!important;height:28px!important;background:url("https://www.valdevie.co.za/wp-content/uploads/2023/05/vdv-crest-gold.svg") center/contain no-repeat!important}
          .message--user{background:#000!important;color:#fff!important}
          .send-button{background:#a3863b!important;color:#fff!important;border:none!important}
          .send-button:hover{filter:brightness(.92)!important}
          .launcher{background:#000!important;color:#fff!important}
          .launcher:hover{background:#a3863b!important;color:#fff!important}
        `;
        el.shadowRoot.appendChild(st);
      }
      return true;
    }

    (async()=>{
      try{
        await load("https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.umd.js");
        // ensure it mounts; if not, try again shortly
        let tries=0;
        const t=setInterval(()=>{
          if (initWidget() && brandShadow()){ clearInterval(t); }
          if (++tries>30){ clearInterval(t); console.error('n8n widget failed to init (blocked by extension?)'); }
        },150);
      }catch(e){ console.error(e.message); }
    })();
  </script>
</body>
</html>
