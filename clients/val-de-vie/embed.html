<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Val de Vie Assistant (Demo)</title>

  <!-- n8n widget base CSS -->
  <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />

  <!-- Global + Client CSS -->
  <link rel="stylesheet" href="../../brand.css" />
  <link rel="stylesheet" href="../../themes/val-de-vie.css?v=40" />
</head>
<body>
  <!-- Mount target -->
  <div id="n8n-chat"></div>

  <!-- Config FIRST -->
  <script>
    window.ChatWidgetConfig = {
      target: "#n8n-chat",
      webhook: {
        url: "https://n8n.recoverykings.co/webhook/edb8bf04-91b6-420c-b119-a9d24cd8d4d3/chat",
        route: "general"
      },
      initialMessages: [
        { role: "assistant", text: "Welcome to Val de Vie Properties! How can I help you today?" }
      ],
      placeholder: "Type your message…",
      position: "bottom-right",
      header: { title: "Val de Vie Properties" },
      openOnLoad: true
    };
  </script>

  <!-- Robust loader: try UMDs -> force init; else ESM fallback -->
  <script>
    (function () {
      const UMD_URLS = [
        // Friendly filenames (adblockers usually allow these)
        "https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.umd.js",
        "https://unpkg.com/@n8n/chat/dist/chat.umd.js",
        // Often-blocked filenames (we try anyway)
        "https://cdn.jsdelivr.net/npm/@n8n/chat/dist/index.global.js",
        "https://unpkg.com/@n8n/chat/dist/index.global.js",
        "https://cdn.jsdelivr.net/npm/@n8n/chat/dist/index.umd.js",
        "https://unpkg.com/@n8n/chat/dist/index.umd.js"
      ];

      const tryGetFactory = () => {
        // Cover known globals across builds
        const candidates = [
          () => window.N8NChat && window.N8NChat.createChat,
          () => window.N8N && window.N8N.Chat && window.N8N.Chat.createChat,
          () => window.createChat,                    // some UMDs export this
          () => window.Chat && window.Chat.create,    // rare alt
          () => window.Chat && window.Chat.createChat
        ];
        for (const f of candidates) {
          try { const fn = f(); if (typeof fn === "function") return fn; } catch {}
        }
        return null;
      };

      const forceInit = () => {
        const create = tryGetFactory();
        const cfg = window.ChatWidgetConfig || {};
        if (!create) return false;

        // Avoid double mount
        const already = document.querySelector("#n8n-chat n8n-chat");
        if (!already) {
          create({
            webhookUrl: cfg.webhook && cfg.webhook.url,
            target: cfg.target || "#n8n-chat",
            position: cfg.position || "bottom-right",
            placeholder: cfg.placeholder || "Type your message…",
            initialMessages: cfg.initialMessages || [],
            header: cfg.header || { title: "Val de Vie Properties" },
            openOnLoad: !!cfg.openOnLoad
          });
        }
        return true;
      };

      const loadScript = (src) => new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.async = true;
        s.onload = resolve;
        s.onerror = reject;
        document.body.appendChild(s);
      });

      (async () => {
        // 1) Try UMDs one by one; after each load, try to init
        for (const url of UMD_URLS) {
          try {
            await loadScript(url);
            // give the script a microtask to attach globals
            await Promise.resolve();
            if (forceInit()) return;
          } catch (e) {
            // continue to next url
          }
        }

        // 2) ESM fallback: import and init programmatically
        const m = document.createElement("script");
        m.type = "module";
        m.textContent = `
          import * as mod from "https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js";
          const create = mod.createChat || (window.N8NChat && window.N8NChat.createChat);
          const cfg = window.ChatWidgetConfig || {};
          if (typeof create === "function") {
            create({
              webhookUrl: cfg.webhook?.url,
              target: cfg.target || "#n8n-chat",
              position: cfg.position || "bottom-right",
              placeholder: cfg.placeholder || "Type your message…",
              initialMessages: cfg.initialMessages || [],
              header: cfg.header || { title: "Val de Vie Properties" },
              openOnLoad: !!cfg.openOnLoad
            });
          } else {
            console.error("Failed to initialize n8n chat: no factory function found.");
          }
        `;
        document.body.appendChild(m);
      })();
    })();
  </script>
</body>
</html>
