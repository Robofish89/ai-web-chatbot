<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Val de Vie Assistant (Demo)</title>

  <!-- n8n widget base CSS -->
  <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />

  <!-- Global + Client CSS -->
  <link rel="stylesheet" href="../../brand.css" />
  <link rel="stylesheet" href="../../themes/val-de-vie.css?v=50" />
</head>
<body>
  <!-- Mount target -->
  <div id="n8n-chat"></div>

  <!-- Config -->
  <script>
    window.ChatWidgetConfig = {
      target: "#n8n-chat",
      webhook: {
        url: "https://n8n.recoverykings.co/webhook/edb8bf04-91b6-420c-b119-a9d24cd8d4d3/chat",
        route: "general"
      },
      initialMessages: [
        { role: "assistant", text: "Welcome to Val de Vie Properties! How can I help you today?" }
      ],
      placeholder: "Type your messageâ€¦",
      position: "bottom-right",
      header: { title: "Val de Vie Properties" },
      openOnLoad: true
    };
  </script>

  <!-- Loader + Shadow DOM style injection -->
  <script>
    (function () {
      const load = (url) =>
        new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = url;
          s.async = true;
          s.onload = resolve;
          s.onerror = reject;
          document.body.appendChild(s);
        });

      const init = () => {
        const cfg = window.ChatWidgetConfig || {};
        const create =
          (window.N8NChat && window.N8NChat.createChat) ||
          window.createChat;
        if (typeof create !== "function") return false;

        create({
          webhookUrl: cfg.webhook.url,
          target: "#n8n-chat",
          position: "bottom-right",
          placeholder: cfg.placeholder,
          initialMessages: cfg.initialMessages,
          header: cfg.header,
          openOnLoad: true,
        });

        // Inject Val de Vie styles into shadow root
        setTimeout(() => {
          const el = document.querySelector("n8n-chat");
          if (el && el.shadowRoot) {
            const style = document.createElement("style");
            style.textContent = `
              /* Header */
              .header { background:#000 !important; color:#fff !important; }
              .header-title {
                font-size:0 !important; height:28px !important;
                background:url("https://www.valdevie.co.za/wp-content/uploads/2023/05/vdv-crest-gold.svg")
                  center/contain no-repeat !important;
              }

              /* User bubbles */
              .message--user { background:#000 !important; color:#fff !important; }

              /* Send button */
              .send-button { background:#a3863b !important; color:#fff !important; border:none !important; }
              .send-button:hover { filter:brightness(0.92) !important; }

              /* Launcher (speech bubble) */
              .launcher { background:#000 !important; color:#fff !important; }
              .launcher:hover { background:#a3863b !important; color:#fff !important; }
            `;
            el.shadowRoot.appendChild(style);
          }
        }, 600);

        return true;
      };

      (async () => {
        try {
          await load("https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.umd.js");
          init() || console.error("n8n chat init failed");
        } catch {
          console.error("Failed to load chat.umd.js");
        }
      })();
    })();
  </script>
</body>
</html>
